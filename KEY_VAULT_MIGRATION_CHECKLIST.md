# Azure Key Vault Migration Checklist

## Pre-Deployment Checklist

### ‚úÖ Code Changes Complete
- [x] Added Spring Cloud Azure dependency to `pom.xml`
- [x] Created `key_vault.tf` with RBAC configuration
- [x] Updated `container_app.tf` with managed identity
- [x] Added `key_vault_name` variable to `variables.tf`
- [x] Added Key Vault outputs to `outputs.tf`
- [x] Updated `application.properties` with Key Vault config
- [x] Updated GitHub Actions workflow with Key Vault variables

### üìã GitHub Secrets Required
- [ ] `AZURE_CREDENTIALS` - Service principal JSON with these roles:
  - Contributor on subscription (or resource group)
  - Key Vault Administrator on Key Vault (will be assigned by Terraform)

**Note**: `POSTGRES_ADMIN_PASSWORD` is NO LONGER REQUIRED! The password is now auto-generated by Terraform using `random_password` resource and stored directly in Key Vault. No human ever needs to know the password.

### üîß Azure Permissions Required
Your service principal needs:
- [ ] `Contributor` role on subscription or resource group
- [ ] Terraform will automatically grant itself `Key Vault Administrator` role

### üåê Globally Unique Names
Verify these are unique (or will be made unique with suffix):
- [ ] `KEY_VAULT_NAME` in workflow (default: `kv-quiz-app`)
- [ ] `ACR_NAME` (default: `acrquizapp123`)
- [ ] `POSTGRES_SERVER_NAME` (default: `psql-quiz-app-123`)

## Deployment Steps

### 1. Review Changes
```bash
# Check all modified files
git status

# Review changes
git diff main
```

### 2. Commit and Push
```bash
git add .
git commit -m "Add Azure Key Vault integration with managed identity"
git push origin add_keyvault
```

### 3. Create Pull Request
- [ ] Create PR from `add_keyvault` to `main`
- [ ] Review changes in GitHub UI
- [ ] Check that workflow is ready to run

### 4. Monitor Deployment
- [ ] Watch GitHub Actions workflow
- [ ] Check each job completes successfully:
  - test
  - terraform (infrastructure)
  - build-and-push
  - migrate-database
  - deploy-app

### 5. Post-Deployment Verification

#### Check Key Vault Created
```bash
# List Key Vaults in resource group
az keyvault list --resource-group rg-quiz-app --output table

# Expected: kv-quiz-app-<suffix>
```

#### Check Secret Stored
```bash
# Show secret (won't display value)
az keyvault secret show \
  --vault-name kv-quiz-app-<suffix> \
  --name postgres-admin-password \
  --query "name,attributes.enabled"

# Expected: {"name": "postgres-admin-password", "enabled": true}
```

#### Check Managed Identity
```bash
# Get Container App identity
az containerapp show \
  --name app-quiz \
  --resource-group rg-quiz-app \
  --query "identity.type,identity.principalId"

# Expected: {"principalId": "<guid>", "type": "SystemAssigned"}
```

#### Check Role Assignment
```bash
# List role assignments on Key Vault
az role assignment list \
  --scope $(az keyvault show --name kv-quiz-app-<suffix> --resource-group rg-quiz-app --query id -o tsv) \
  --query "[].{Principal:principalName,Role:roleDefinitionName}" \
  --output table

# Expected: Container App with "Key Vault Secrets User"
```

#### Test Application
```bash
# Get Container App URL
FQDN=$(az containerapp show \
  --name app-quiz \
  --resource-group rg-quiz-app \
  --query properties.configuration.ingress.fqdn \
  --output tsv)

echo "Application URL: https://$FQDN"

# Test API
curl -s "https://$FQDN/api/quizzes" | jq '.[0].title'

# Expected: "3.2 British America - Quiz Game" or similar
```

#### Check Container App Logs
```bash
# View recent logs
az containerapp logs show \
  --name app-quiz \
  --resource-group rg-quiz-app \
  --tail 50

# Look for:
# ‚úÖ "Started Application in X seconds"
# ‚úÖ No Key Vault access errors
# ‚úÖ No authentication failures
# ‚ùå Should NOT see actual password values in logs
```

## Rollback Plan (If Needed)

### Option 1: Revert to Previous Commit
```bash
# If deployment fails, revert changes
git revert HEAD
git push origin add_keyvault
```

### Option 2: Manual Terraform Destroy
```bash
cd infra

# Destroy only Key Vault resources
terraform destroy \
  -target=azurerm_key_vault_secret.postgres_password \
  -target=azurerm_role_assignment.terraform_keyvault_admin \
  -target=azurerm_key_vault.main

# Container App will fall back to previous configuration
```

### Option 3: Re-add Hardcoded Secret
If you need to temporarily restore the old setup:
1. Add back the secret block in `container_app.tf`
2. Remove Key Vault environment variables
3. Re-apply Terraform

## Success Criteria

### ‚úÖ Deployment Successful When:
1. GitHub Actions workflow completes all jobs
2. Key Vault exists with secret stored
3. Container App has System-Assigned Identity
4. Container App has "Key Vault Secrets User" role
5. API endpoint returns quiz data
6. No errors in Container App logs
7. No hardcoded secrets in container environment

### ‚ö†Ô∏è Warning Signs:
- "Access denied" errors in logs
- "Secret not found" errors
- Application fails to start
- Database connection errors

## Common Issues and Solutions

### Issue: Key Vault name not unique
**Error**: `A vault with the same name already exists in deleted state`
**Solution**: 
```bash
# Purge soft-deleted vault
az keyvault purge --name kv-quiz-app-<suffix>
# Or change KEY_VAULT_NAME in workflow
```

### Issue: Role assignment not propagated
**Error**: `Access denied` in Container App logs
**Solution**:
```bash
# Wait 5-10 minutes for Azure AD propagation
# Or manually grant role:
az role assignment create \
  --role "Key Vault Secrets User" \
  --assignee <container-app-principal-id> \
  --scope <key-vault-id>
```

### Issue: Spring Cloud Azure not loading secrets
**Error**: Application uses literal value `$${postgres-admin-password}`
**Solution**:
1. Check environment variables are set in Container App
2. Verify Spring Cloud Azure dependency in classpath
3. Check Key Vault endpoint is correct
4. Ensure managed identity is enabled

## Next Steps After Successful Deployment

### 1. Clean Up Branch
```bash
# Merge to main if successful
git checkout main
git merge add_keyvault
git push origin main

# Delete feature branch
git branch -d add_keyvault
git push origin --delete add_keyvault
```

### 2. Update Documentation
- [ ] Update main README.md with Key Vault setup
- [ ] Document secret rotation process
- [ ] Add troubleshooting guide

### 3. Security Hardening (Optional)
- [ ] Enable Key Vault firewall (deny by default)
- [ ] Add Private Endpoint for Key Vault
- [ ] Enable Key Vault diagnostic logging
- [ ] Set up secret expiration alerts

### 4. Secret Rotation Setup
- [ ] Configure automatic rotation policy
- [ ] Set up rotation notification
- [ ] Document manual rotation procedure

## Validation Commands Summary

```bash
# All-in-one validation script
export RG="rg-quiz-app"
export KV_NAME=$(az keyvault list -g $RG --query "[0].name" -o tsv)
export APP_NAME="app-quiz"

echo "=== Key Vault Status ==="
az keyvault show --name $KV_NAME -g $RG --query "{Name:name,RBAC:properties.enableRbacAuthorization}" -o table

echo -e "\n=== Secrets ==="
az keyvault secret list --vault-name $KV_NAME --query "[].name" -o table

echo -e "\n=== Container App Identity ==="
az containerapp show -n $APP_NAME -g $RG --query "identity.{Type:type,PrincipalId:principalId}" -o table

echo -e "\n=== Role Assignments ==="
az role assignment list --scope $(az keyvault show --name $KV_NAME -g $RG --query id -o tsv) --query "[].{Role:roleDefinitionName,Type:principalType}" -o table

echo -e "\n=== Application Health ==="
FQDN=$(az containerapp show -n $APP_NAME -g $RG --query "properties.configuration.ingress.fqdn" -o tsv)
curl -s -o /dev/null -w "Status: %{http_code}\n" "https://$FQDN/api/quizzes"
```

## Support Contacts

- **Azure Support**: https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade
- **Spring Cloud Azure Issues**: https://github.com/Azure/azure-sdk-for-java/issues
- **Internal Team**: [Add your team contact info]
